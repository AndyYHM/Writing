## 20181229-Patroni_1.5.3源码阅读笔记

## 1. 我的Blog
> 博客园 https://www.cnblogs.com/piggybaba

> 个人网站 http://piggybaba.cn

> GitHub https://github.com/AndyYHM/Writing


## 2. 简介信息
> 摘要：Patroni_1.5.3源码阅读笔记postgresql

> Author: andy_yhm@yeah.net

> Date: 20181229

> 关键字：python，python3,patroni,source code,postgresql


## 约定
- 根目录/patroni-1.5.3,记为{root_dir}
- 按文件阅读
- 文末理清原理，文中只记录实现功能

## {root_dir}/patroni/ 模块说明

### __init__.py
#### 1. 定义Patroni类，拥有以下方法
- load_dynamic_configuration(), 调用patroni.dcs模块,获取DCS集群信息（etcd、zookeeper等），获取不到即报错”Can not get cluster from dcs”
变量cluster=patroni.dcs.get_dcs(Config()).get_cluster()
- get_tags(),  读取YMAL配置文件中“tag”部分配置，tags示例：
    nofailover: false
    noloadbalance: false
    clonefrom: false
    nosync: false”
- nofailover(), 布尔值，返回是否获取到‘nofailover，False’标记
- nosync()，布尔值，返回是否获取到‘nosync，False’标记
- reload_config()，调用dcs/watchdog/api/postgresql模块下的reload_config方法
- replicatefrom(), 返回值，获取配置文件中'replicatefrom'配置值，实际检查无该项*，应为bug，存在clonefrom tag项
- sighup_handler()
- sigterm_handler()
- noloadbalance（），布尔值，返回是否获取到‘noloadbalance，False’标记
- schedule_next_run（），设定下一次查询dcs时间值，最小sleep 0.001sec,同时报错”Loop time exceeded, rescheduling immediately.“
- run(), 读取dcs配置信息，启用dcs访问连接；读取数据库配置文件
- setup_signal_handlers
- shutdown()

#### 2. 定义patroni_main()
实例化Patroni Class，执行run启动，如遇except，则shutdown（）

#### 3. 定义pg_ctl_start（）


#### 4. call_self（）
通过subprocess.Popen调用
#### 5. main（）



### api.py
####

## 入口patroni.py
### 调用main()函数，位于{root_dir}/patroni/__init__.py
#### main()
